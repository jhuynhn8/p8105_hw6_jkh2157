---
title: "p8105_hw6_jkh2157"
output: github_document
date: "2025-12-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(modelr)
library(purrr)
library(readr)
library(p8105.datasets)
```

# Problem 1 

#### Data Cleaning 

```{r}
homicide_df = 
  read_csv("data/homicide-data.csv") |>
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    victim_race = fct_relevel(victim_race, "White")
  ) |>
  filter(
    !(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),
    victim_race %in% c("White", "Black")
  ) |>
  mutate(resolved = as.numeric(disposition == "Closed by arrest"))

#checking to make sure that it correctly dropped those states 

homicide_df |> 
  distinct(city_state) |> 
  filter(city_state %in% c(
    "Dallas, TX",
    "Phoenix, AZ",
    "Kansas City, MO",
    "Tulsa, AL"
  ))
```

#### Logistic Regression for Baltimore 

```{r}
baltimore_df =
  homicide_df |> 
  filter(city_state == "Baltimore, MD")

fit_baltimore =
  baltimore_df |>
  glm(resolved ~ victim_age + victim_race + victim_sex,
      data = _,
      family = binomial())

baltimore_or =
  fit_baltimore |>
  tidy() |>
  mutate(OR = exp(estimate)) |>
  select(term, log_OR = estimate, OR, p.value)

baltimore_or |> 
  filter(term == "victim_sexMale")

#creating a nicer table 

baltimore_results =
  fit_baltimore |> 
  tidy() |>
  mutate(
    OR = exp(estimate),
    ci_lower = exp(estimate - 1.96 * std.error),
    ci_upper = exp(estimate + 1.96 * std.error)
  ) |>
  filter(term == "victim_sexMale") |>
  select(
    term,
    log_OR = estimate,
    OR,
    ci_lower,
    ci_upper,
    p.value
  )

baltimore_results |> 
  knitr::kable(digits = 3)

```

**Interpretation**: Holding age and race constant, male victims have significantly lower odds of having their homicide solved compared to female victims. The adjusted odds ratio is 0.43, indicating that the odds of case resolution for male victims are about 57% lower than for female victims. The association is also statistically significant (p<0.0001) 

#### Linear Regression for other cities: Using nest and map 

```{r}
city_results =
  homicide_df |> 
  nest(data = -city_state) |>
  mutate(
    models = map(data, \(df)
      glm(resolved ~ victim_age + victim_race + victim_sex,
          data = df,
          family = binomial())
    ),
    results = map(models, tidy)
  ) |>
  select(-data, -models) |>
  unnest(results) |>
  mutate(OR = exp(estimate)) |>
  filter(term == "victim_sexMale") |>
  group_by(city_state) |>
  mutate(
    ci_lower = exp(estimate - 1.96 * std.error),
    ci_upper = exp(estimate + 1.96 * std.error)
  ) |>
  ungroup()

#creating nicer tables 
city_results_table =
  city_results |> 
  select(
    city_state,
    log_OR = estimate,
    OR,
    ci_lower,
    ci_upper,
    p.value
  ) |>
  arrange(OR)

city_results_table |> 
  knitr::kable(digits = 3)

model.matrix(~ victim_sex, data = homicide_df) |> head()
```

**Interpretation**: Across U.S. cities, the adjusted odds of solving a homicide are consistently lower for male victims than for female victims, even after controlling for age and race.

#### Plot estimated ORs and CI 

```{r}
city_results |> 
  ggplot(aes(x = fct_reorder(city_state, OR), y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper)) +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted Odds Ratio",
    title = "Adjusted ORs for Homicide Resolution Across U.S. Cities"
  )
```

# Problem 2 

#### Looking at data set 

```{r}
data("weather_df")

weather_df =
  weather_df |> 
  drop_na(tmax, tmin, prcp)
```


